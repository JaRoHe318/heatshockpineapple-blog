---
import BaseLayout from './BaseLayout.astro';

interface Props {
  title: string;
  description: string;
  pubDate: Date;
  slug: string;
}

const { title, description, pubDate, slug } = Astro.props;

// CITATION LOGIC
const year = pubDate.getFullYear();
const today = new Date().toISOString().split('T')[0];
const url = `https://blog.heatshockpineapple.com/posts/${slug}`;
const bibtex = `@misc{hernandez${year},
  author = {Hernandez, Jason},
  title = {${title}},
  year = {${year}},
  howpublished = {\\url{${url}}},
  note = {Accessed: ${today}}
}`;
---

<BaseLayout title={title} description={description} pubDate={pubDate} wide={true}>
  
  <article class="post-container">
    
    <header class="post-header">
      <div class="header-content">
        <time class="mono-meta">
          {pubDate.toLocaleDateString('en-US', { dateStyle: 'long' })}
        </time>
        
        <h1>{title}</h1>
      </div>
    </header>
    
    <div class="post-content markdown-body">
      <slot />
    </div>

    <div class="citation-section">
      <div class="citation-box">
        <h3>Cite this protocol</h3>
        <p class="citation-desc">
          If you found this useful for your own work, you can cite it using the BibTeX entry below.
        </p>
        
        <div class="code-block-wrapper">
          <pre><code id="bibtex-code">{bibtex}</code></pre>
          <button id="copy-btn" class="copy-button" aria-label="Copy to clipboard">
            Copy BibTeX
          </button>
        </div>
        <span id="copy-feedback" class="copy-feedback">Copied to clipboard!</span>
      </div>
    </div>

    <div class="post-footer">
      <a href="/archive" class="back-link">‚Üê Return to Archive</a>
    </div>

  </article>
</BaseLayout>

<script>
  // Copy Button Logic
  const btn = document.getElementById('copy-btn');
  const code = document.getElementById('bibtex-code');
  const feedback = document.getElementById('copy-feedback');

  if (btn && code && feedback) {
    btn.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(code.innerText);
        feedback.classList.add('visible');
        btn.innerText = 'Copied!';
        setTimeout(() => {
          feedback.classList.remove('visible');
          btn.innerText = 'Copy BibTeX';
        }, 2000);
      } catch (err) {
        console.error('Failed to copy text: ', err);
      }
    });
  }
</script>

<style>
  /* === LAYOUT STRUCTURE === */
  .post-container {
    width: 100%;
    margin: 0 auto;
  }

  .header-content, 
  .post-content, 
  .citation-section, 
  .post-footer {
    max-width: 740px; 
    margin-left: auto;
    margin-right: auto;
  }

  /* === HEADER VISUALS (Cleaned Up) === */
  .post-header {
    position: relative;
    padding: 6rem 0 3rem; /* Spacious top padding */
    margin-bottom: 3rem;
    
    /* REPLACED: Solid border with a softer dashed "Notebook" line */
    border-bottom: 1px dashed var(--border);
    
    width: 100%;
  }

  /* Typography */
  h1 { 
    margin-top: 0.5rem; 
    font-size: 2.75rem; /* Slightly larger */
    line-height: 1.1; 
    font-family: var(--font-serif);
    color: var(--text-main);
  }

  .mono-meta {
    display: block;
    font-family: var(--font-mono);
    font-size: 0.9rem;
    /* CHANGE: Matches the Gold system */
    color: var(--accent-secondary); 
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.5rem;
  }

  /* === CITATION BOX === */
  .citation-section { margin-top: 4rem; margin-bottom: 4rem; }
  
  .citation-box {
    padding: 2rem;
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
  }

  .citation-box h3 {
    margin-top: 0;
    font-size: 0.85rem;
    font-family: var(--font-mono);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    /* Green Header */
    color: var(--accent-nature); 
  }

  .citation-desc {
    font-size: 0.95rem;
    color: var(--text-muted);
    margin-bottom: 1.5rem;
    font-family: var(--font-sans);
    line-height: 1.5;
  }

  .code-block-wrapper {
    position: relative;
    background: var(--bg-paper);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 1.25rem;
    overflow-x: auto;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
  }

  pre {
    margin: 0;
    white-space: pre-wrap;
    font-family: var(--font-mono);
    font-size: 0.8rem;
    color: var(--text-body);
    flex: 1;
    line-height: 1.5;
  }

  .copy-button {
    background: transparent;
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 0.4rem 0.8rem;
    font-family: var(--font-mono);
    font-size: 0.75rem;
    cursor: pointer;
    color: var(--text-muted);
    margin-left: 1rem;
    transition: all 0.2s;
    white-space: nowrap;
  }

  .copy-button:hover {
    /* Heat Shock Interaction */
    color: var(--accent-primary);
    border-color: var(--accent-primary);
    background: rgba(138, 58, 75, 0.05);
  }

  .copy-feedback {
    display: block;
    margin-top: 0.75rem;
    font-size: 0.8rem;
    color: var(--accent-primary);
    font-family: var(--font-mono);
    opacity: 0;
    transition: opacity 0.3s;
    height: 1.2em;
  }
  .copy-feedback.visible { opacity: 1; }

  /* === FOOTER === */
  .post-footer {
    padding-top: 2rem;
    border-top: 1px dashed var(--border);
    margin-bottom: 4rem;
  }
  .back-link {
    font-family: var(--font-mono);
    font-size: 0.9rem;
    color: var(--accent-nature); /* Green link */
    text-decoration: none;
    transition: color 0.2s;
  }
  .back-link:hover { color: var(--accent-primary); /* Red hover */ }
</style>